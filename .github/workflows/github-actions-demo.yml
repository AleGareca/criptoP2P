name: Java CI

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 18
        uses: actions/setup-java@v3
        with:
          java-version: '18'
          distribution: 'adopt'

      #- name: Deploy to Heroku
       #uses: AkhileshNS/heroku-deploy@v3.8.8
        #with:
          #heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          #heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          #heroku_email: ${{ secrets.HEROKU_EMAIL }}

      - name: Heroku login credentials
        run: |
          cat > ~/.netrc <<EOF
          machine api.heroku.com
          login $HEROKU_EMAIL
          password $HEROKU_API_KEY
          machine git.heroku.com
          login $HEROKU_EMAIL
          password $HEROKU_API_KEY
          EOF
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL }}
      - name: Push to Heroku
        run: git push heroku main
      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@e6e38bacfdf1a337459f332974bb2327a31aaf4b

      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@e6e38bacfdf1a337459f332974bb2327a31aaf4b
      - name: Run chmod to make gradlew executable
        run: chmod +x ./gradlew
      - name: Build with Gradle
        uses: gradle/gradle-build-action@v2

      - name: Run Coverage
        run: |
            chmod +x gradlew
            ./gradlew test jacocoTestReport
      ##- name: Add coverage to PR
        ##id: jacoco
        ##uses: madrapps/jacoco-report@v1.3
        ##with:
            ##paths: ${{ github.workspace }}/build/reports/jacoco/testCoverage/testCoverage.xml
            ##token: ${{ secrets.TOKEN_GITHUB }}
            ##min-coverage-overall: 0
            ##min-coverage-changed-files: 0
          #- uses: akhileshns/heroku-deploy@v3.12.12 # This is the action
          # with:
          #run: heroku git:remote -a cripto-p2p-unq
          #heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          #heroku_app_name: "cripto-p2p-unq" #Must be unique in Heroku
          #heroku_email: "gereca20jorge@gmail.com"
          #branch: "main"

